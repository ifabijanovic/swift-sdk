//
//  KCSRealmTests.m
//  KinveyKit
//
//  Created by Victor Barros on 2015-11-23.
//  Copyright Â© 2015 Kinvey. All rights reserved.
//

#import "KCSTestCase.h"
#import <KinveyKit/KinveyKit.h>

#import "KCSPerson.h"

@interface KCSRealmTests : KCSTestCase

@property (nonatomic, strong) KCSCollection* collection;
@property (nonatomic, strong) id<KCSStore> store;

@end

@implementation KCSRealmTests

- (void)setUp {
    [super setUp];
    
    [self setupKCS];
    [self createAutogeneratedUser];
    
    self.collection = [KCSCollection collectionFromString:@"person"
                                                  ofClass:[KCSPerson class]];
    self.store = [KCSBackgroundAppdataStore storeWithCollection:self.collection
                                                        options:nil];
}

- (void)tearDown {
    [self removeAndLogoutActiveUser:30];
    
    [super tearDown];
}

- (void)testIsKindOfClass {
    KCSPerson* person = [KCSPerson alloc];
    XCTAssertTrue([person isKindOfClass:[KCSPerson class]]);
    XCTAssertEqualObjects(NSStringFromClass([person class]), @"KCSPerson__Kinvey");
}

- (void)testSave {
    KCSPerson* person = [[KCSPerson alloc] init];
    person.name = @"Victor";
    person.age = 29;
    KCSAddress* address = [[KCSAddress alloc] init];
    address.city = @"Vancouver";
    address.province = @"BC";
    address.country = @"Canada";
    person.address = address;
    
    __block __weak XCTestExpectation* expectationSave = [self expectationWithDescription:@"save"];
    
    [self.store saveObject:person
       withCompletionBlock:^(NSArray *objectsOrNil, NSError *errorOrNil)
    {
        XCTAssertNotNil(objectsOrNil);
        XCTAssertNil(errorOrNil);
        
        [expectationSave fulfill];
    } withProgressBlock:nil];
    
    [self waitForExpectationsWithTimeout:30
                                 handler:^(NSError * _Nullable error)
    {
        expectationSave = nil;
    }];
}

@end
